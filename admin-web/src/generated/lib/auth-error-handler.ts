/**
 * Authentication Error Handler
 * Auto-generated by Mulink - Handles authentication errors globally and redirects users to login when needed
 * 
 * Best Practices:
 * - Type-safe error handling with proper TypeScript types
 * - Graceful error handling with fallbacks
 * - User-friendly error messages
 * - Proper session cleanup on auth errors
 */

import type { ApiError } from '@/generated/client/base'
// Auth not configured - signOut will need to be imported manually

// Toast notification (optional - can be replaced with your preferred notification library)
// If you use a different toast library, update the import and usage below
let toast: {
  error: (message: string, options?: { duration?: number; description?: string }) => void
} | null = null

// Lazy load toast to avoid bundling issues
async function getToast(): Promise<{
  error: (message: string, options?: { duration?: number; description?: string }) => void
} | null> {
  if (toast !== null) return toast
  
  try {
    // Try to import sonner (common toast library)
    const sonner = await import('sonner')
    toast = sonner.toast
    return toast
  } catch {
    // Fallback to console if toast library not available
    toast = {
      error: (message: string, options?: { duration?: number; description?: string }) => {
        console.error('[Auth Error]', message, options?.description || '')
      }
    }
    return toast
  }
}

/**
 * Type guard to check if an error is an authentication error
 */
export function isAuthError(error: unknown): boolean {
  if (error && typeof error === 'object' && 'status' in error) {
    const status = (error as ApiError).status
    return status === 401 || status === 403
  }
  return false
}

/**
 * Type guard to check if an error is an inactive account error
 * Auto-detected account status patterns from schema
 */
export function isInactiveAccountError(error: unknown): boolean {
  if (!isAuthError(error)) return false
  
  const apiError = error as ApiError
  const errorMessage = apiError.data?.detail || apiError.message || ''
  const lowerMessage = errorMessage.toLowerCase()
  const errorCode = (apiError.data as any)?.error_code || ''
  const lowerErrorCode = errorCode.toLowerCase()
  
  // Auto-detected inactive statuses: "inactive"
  const inactiveStatuses = ["inactive"]
  const inactiveStatusCheck = inactiveStatuses.some(status => 
    lowerMessage.includes(status.toLowerCase()) || 
    lowerErrorCode.includes(status.toLowerCase())
  )
  
  return (
    (apiError.status === 403 && (
      inactiveStatusCheck ||
      lowerMessage.includes('not active') ||
      lowerMessage.includes('inactive') ||
      lowerMessage.includes('account is not active') ||
      lowerMessage.includes('user account is not active') ||
      lowerErrorCode === 'user_account_inactive'
    )) ||
    lowerErrorCode === 'user_account_inactive' ||
    inactiveStatusCheck
  )
}

/**
 * Main auth error handler function
 * Handles authentication errors and redirects users appropriately
 * 
 * @param error - The error to handle (should be an ApiError)
 * @param redirectTo - Optional custom redirect path (default: /auth/signin)
 */
export async function handleAuthError(error: unknown, redirectTo?: string): Promise<void> {
  if (typeof window === 'undefined') {
    console.error('[Auth Error Handler] Auth error on server:', error)
    return
  }

  if (!isAuthError(error)) {
    return
  }

  const apiError = error as ApiError
  const isInactive = isInactiveAccountError(error)
  const errorMessage = apiError.data?.detail || apiError.message || ''
  
  console.warn('[Auth Error Handler] Authentication error detected:', {
    status: apiError.status,
    message: errorMessage,
    isInactive,
  })

  const toastInstance = await getToast()

  // Show appropriate error message based on error type
  if (toastInstance) {
    if (isInactive) {
      toastInstance.error('Your account has been deactivated. Please contact support for assistance.', {
        duration: 5000,
        description: 'You will be redirected to the login page.',
      })
    } else if (apiError.status === 401) {
      toastInstance.error('Your session has expired. Please sign in again.', {
        duration: 4000,
      })
    } else if (apiError.status === 403) {
      toastInstance.error('Access denied. Your account may have been suspended.', {
        duration: 5000,
        description: 'You will be redirected to the login page.',
      })
    } else {
      toastInstance.error('Authentication failed. Please sign in again.', {
        duration: 4000,
      })
    }
  }

  if (typeof window !== 'undefined') {
    const targetUrl = redirectTo || '/auth/signin'
    
    // Start sign out in background (don't wait for it)
    // signOut not configured - implement your own sign out logic here
    
    // Force immediate redirect - this will stop all JavaScript execution
    // Use replace to prevent back button from going to the previous page
    console.log('[Auth Error Handler] Redirecting to:', targetUrl)
    window.location.replace(targetUrl)
  }
}

/**
 * Factory function to create an auth error handler with custom redirect path
 * Useful for creating error handlers with specific redirect paths
 * 
 * @param redirectTo - Custom redirect path
 * @returns Error handler function
 */
export function createAuthErrorHandler(redirectTo?: string) {
  return async (error: unknown) => {
    await handleAuthError(error, redirectTo)
    throw error // Re-throw to allow other error handlers to process it
  }
}
