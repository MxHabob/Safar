// Prisma schema for Safar platform (35+ models, PostGIS enabled)
generator client {
  provider        = "prisma-client-js"
  previewFeatures = ["postgresqlExtensions"]
}

datasource db {
  provider  = "postgresql"
  url       = env("DATABASE_URL")
  extensions = [
    PostgreSQLExtension(
      name = "postgis",
      schema = "public"
    )
  ]
}

enum BookingStatus {
  PENDING
  CONFIRMED
  CANCELLED
  CHECKED_IN
  CHECKED_OUT
  REFUNDED
}

enum PaymentStatus {
  INITIATED
  AUTHORIZED
  CAPTURED
  FAILED
  REFUNDED
}

enum PayoutStatus {
  SCHEDULED
  IN_FLIGHT
  SETTLED
  FAILED
  CANCELLED
}

enum ReviewVisibility {
  PUBLIC
  HIDDEN
  FLAGGED
}

enum AccountProvider {
  PASSWORD
  GOOGLE
  APPLE
  FACEBOOK
  GITHUB
}

model User {
  id                String           @id @default(cuid())
  email             String           @unique
  phone             String?
  fullName          String
  locale            String           @default("en")
  avatarUrl         String?
  roles             String[]         @default([])
  status            String           @default("active")
  metadata          Json?
  devices           UserDevice[]
  passkeys          UserPasskey[]
  twoFactor         TwoFactorChallenge[]
  accounts          Account[]
  hostProfile       HostProfile?
  bookings          Booking[]        @relation("GuestBookings")
  reviews           Review[]         @relation("GuestReviews")
  conversations     Conversation[]   @relation("ConversationParticipants")
  loyaltyLedger     LoyaltyLedger[]
  promotions        PromotionRedemption[]
  notifications     Notification[]
  payouts           Payout[]
  auditLogs         AuditLog[]
  createdAt         DateTime         @default(now())
  updatedAt         DateTime         @updatedAt
}

model Account {
  id             String          @id @default(cuid())
  provider       AccountProvider
  providerId     String
  accessToken    String?
  refreshToken   String?
  scopes         String[]
  expiresAt      DateTime?
  userId         String
  user           User            @relation(fields: [userId], references: [id])
  createdAt      DateTime        @default(now())
  updatedAt      DateTime        @updatedAt
  @@unique([provider, providerId])
}

model UserDevice {
  id          String   @id @default(cuid())
  userId      String
  user        User     @relation(fields: [userId], references: [id])
  platform    String
  fingerprint String
  lastSeenAt  DateTime @default(now())
  createdAt   DateTime @default(now())
  isTrusted   Boolean  @default(false)
  metadata    Json?
}

model UserPasskey {
  id             String   @id @default(cuid())
  userId         String
  user           User     @relation(fields: [userId], references: [id])
  credentialId   String   @unique
  publicKey      String
  backedUp       Boolean  @default(false)
  transports     String[]
  signCount      Int      @default(0)
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt
}

model TwoFactorChallenge {
  id         String   @id @default(cuid())
  userId     String
  user       User     @relation(fields: [userId], references: [id])
  secret     String
  method     String
  expiresAt  DateTime
  consumedAt DateTime?
  createdAt  DateTime @default(now())
}

model HostProfile {
  id               String        @id @default(cuid())
  userId           String        @unique
  user             User          @relation(fields: [userId], references: [id])
  legalName        String
  status           String        @default("pending")
  badges           String[]
  bio              String?
  taxDocuments     TaxDocument[]
  coHosts          CoHost[]
  listings         Listing[]
  onboardingStep   String        @default("start")
  createdAt        DateTime      @default(now())
  updatedAt        DateTime      @updatedAt
}

model CoHost {
  id          String      @id @default(cuid())
  hostId      String
  host        HostProfile @relation(fields: [hostId], references: [id])
  email       String
  role        String
  status      String      @default("invited")
  createdAt   DateTime    @default(now())
  updatedAt   DateTime    @updatedAt
}

model TaxDocument {
  id          String      @id @default(cuid())
  hostId      String
  host        HostProfile @relation(fields: [hostId], references: [id])
  type        String
  identifier  String
  status      String      @default("pending")
  issuedAt    DateTime?
  expiresAt   DateTime?
  createdAt   DateTime    @default(now())
}

model Listing {
  id              String             @id @default(cuid())
  hostId          String
  host            HostProfile        @relation(fields: [hostId], references: [id])
  title           String
  slug            String             @unique
  summary         String
  description     String
  status          String             @default("draft")
  propertyType    String
  capacity        Int
  bedrooms        Int
  bathrooms       Float
  basePrice       Decimal            @db.Money
  currency        String             @default("USD")
  addressLine1    String
  addressLine2    String?
  city            String
  state           String?
  postalCode      String?
  country         String
  geo             ListingLocation?
  calendar        Calendar?
  amenities       ListingAmenity[]
  images          ListingImage[]
  rules           ListingRule[]
  seasonalOverrides SeasonalOverride[]
  priceCalendars  PriceCalendar[]
  reviews         Review[]
  bookings        Booking[]
  createdAt       DateTime           @default(now())
  updatedAt       DateTime           @updatedAt
  blockedDates    BlockedDate[]
}

model ListingDraft {
  id          String   @id @default(cuid())
  hostId      String
  host        HostProfile @relation(fields: [hostId], references: [id])
  payload     Json
  version     Int      @default(1)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
}

model ListingLocation {
  id          String   @id @default(cuid())
  listingId   String   @unique
  listing     Listing  @relation(fields: [listingId], references: [id])
  timezone    String
  neighborhood String?
  coordinates Unsupported("geography(Point,4326)")
  createdAt   DateTime @default(now())

  @@index([coordinates], type: Gist)
}

model Amenity {
  id        String   @id @default(cuid())
  key       String   @unique
  label     String
  category  String
  listings  ListingAmenity[]
}

model ListingAmenity {
  listingId String
  amenityId String
  listing   Listing @relation(fields: [listingId], references: [id])
  amenity   Amenity @relation(fields: [amenityId], references: [id])
  createdAt DateTime @default(now())

  @@id([listingId, amenityId])
}

model ListingImage {
  id        String   @id @default(cuid())
  listingId String
  listing   Listing  @relation(fields: [listingId], references: [id])
  url       String
  caption   String?
  position  Int      @default(0)
  createdAt DateTime @default(now())
}

model ListingRule {
  id        String   @id @default(cuid())
  listingId String
  listing   Listing  @relation(fields: [listingId], references: [id])
  key       String
  value     String
  createdAt DateTime @default(now())
}

model Calendar {
  id          String              @id @default(cuid())
  listingId   String              @unique
  listing     Listing             @relation(fields: [listingId], references: [id])
  externalIcalUrls String[]       @default([])
  availability Windows
  blocks       AvailabilityWindow[]
  createdAt    DateTime           @default(now())
  updatedAt    DateTime           @updatedAt
}

model BlockedDate {
  id        String   @id @default(cuid())
  listingId String
  listing   Listing  @relation(fields: [listingId], references: [id])
  date      DateTime
  reason    String?
  createdAt DateTime @default(now())

  @@unique([listingId, date])
  @@index([listingId, date])
}

model AvailabilityWindow {
  id          String    @id @default(cuid())
  calendarId  String
  calendar    Calendar  @relation(fields: [calendarId], references: [id])
  startsAt    DateTime
  endsAt      DateTime
  reason      String?
  source      String    @default("manual")
  createdAt   DateTime  @default(now())
}

model SeasonalOverride {
  id          String   @id @default(cuid())
  listingId   String
  listing     Listing  @relation(fields: [listingId], references: [id])
  startsAt    DateTime
  endsAt      DateTime
  minNights   Int?
  maxNights   Int?
  priceFactor Float?
  createdAt   DateTime @default(now())
}

model PricingModel {
  id          String         @id @default(cuid())
  listingId   String
  listing     Listing        @relation(fields: [listingId], references: [id])
  strategy    String         @default("dynamic")
  provider    String         @default("safar-ml")
  metadata    Json?
  rules       PricingRule[]
  createdAt   DateTime       @default(now())
  updatedAt   DateTime       @updatedAt
}

model PricingRule {
  id           String        @id @default(cuid())
  pricingModelId String
  pricingModel PricingModel  @relation(fields: [pricingModelId], references: [id])
  type         String
  payload      Json
  createdAt    DateTime      @default(now())
}

model PriceCalendar {
  id          String    @id @default(cuid())
  listingId   String
  listing     Listing   @relation(fields: [listingId], references: [id])
  date        DateTime
  nightlyRate Decimal   @db.Money
  currency    String    @default("USD")
  minStay     Int       @default(1)
  isBlocked   Boolean   @default(false)
  createdAt   DateTime  @default(now())

  @@unique([listingId, date])
}

model Booking {
  id               String         @id @default(cuid())
  listingId        String
  listing          Listing        @relation(fields: [listingId], references: [id])
  guestId          String
  guest            User           @relation("GuestBookings", fields: [guestId], references: [id])
  status           BookingStatus  @default(PENDING)
  checkIn          DateTime
  checkOut         DateTime
  nights           Int
  guests           Int
  currency         String         @default("USD")
  totalAmount      Decimal        @db.Money
  payoutAmount     Decimal        @db.Money
  fees             Json?
  timeline         BookingTimelineEvent[]
  paymentId        String?
  payment          Payment?       @relation(fields: [paymentId], references: [id])
  messages         Message[]
  reviews          Review[]       @relation("BookingReviews")
  disputes         Dispute[]
  createdAt        DateTime       @default(now())
  updatedAt        DateTime       @updatedAt
}

model BookingTimelineEvent {
  id         String   @id @default(cuid())
  bookingId  String
  booking    Booking  @relation(fields: [bookingId], references: [id])
  status     BookingStatus
  payload    Json?
  createdAt  DateTime @default(now())
}

model PaymentMethod {
  id          String   @id @default(cuid())
  userId      String
  user        User     @relation(fields: [userId], references: [id])
  provider    String
  last4       String
  expMonth    Int?
  expYear     Int?
  token       String
  isDefault   Boolean  @default(false)
  createdAt   DateTime @default(now())
}

model Payment {
  id            String        @id @default(cuid())
  booking       Booking?
  bookingId     String?
  methodId      String?
  method        PaymentMethod? @relation(fields: [methodId], references: [id])
  processor     String
  processorRef  String?
  status        PaymentStatus  @default(INITIATED)
  amount        Decimal        @db.Money
  currency      String         @default("USD")
  capturedAt    DateTime?
  metadata      Json?
  createdAt     DateTime       @default(now())
  updatedAt     DateTime       @updatedAt
}

model PayoutBatch {
  id          String    @id @default(cuid())
  status      PayoutStatus @default(SCHEDULED)
  currency    String    @default("USD")
  totalAmount Decimal    @db.Money
  scheduledAt DateTime
  processedAt DateTime?
  payouts     Payout[]
  createdAt   DateTime   @default(now())
  updatedAt   DateTime   @updatedAt
}

model Payout {
  id          String       @id @default(cuid())
  hostId      String
  host        HostProfile  @relation(fields: [hostId], references: [id])
  bookingId   String?
  booking     Booking?     @relation(fields: [bookingId], references: [id])
  status      PayoutStatus @default(SCHEDULED)
  amount      Decimal      @db.Money
  currency    String       @default("USD")
  destination Json?
  batchId     String?
  batch       PayoutBatch? @relation(fields: [batchId], references: [id])
  createdAt   DateTime     @default(now())
  updatedAt   DateTime     @updatedAt
}

model Review {
  id           String          @id @default(cuid())
  bookingId    String?
  booking      Booking?        @relation(fields: [bookingId], references: [id])
  listingId    String
  listing      Listing         @relation(fields: [listingId], references: [id])
  guestId      String
  guest        User            @relation("GuestReviews", fields: [guestId], references: [id])
  rating       Int
  comment      String
  visibility   ReviewVisibility @default(PUBLIC)
  response     ReviewResponse?
  createdAt    DateTime        @default(now())
}

model ReviewResponse {
  id        String   @id @default(cuid())
  reviewId  String   @unique
  review    Review   @relation(fields: [reviewId], references: [id])
  hostId    String
  host      HostProfile @relation(fields: [hostId], references: [id])
  comment   String
  createdAt DateTime @default(now())
}

model Conversation {
  id            String        @id @default(cuid())
  bookingId     String?
  booking       Booking?      @relation(fields: [bookingId], references: [id])
  listingId     String?
  listing       Listing?      @relation(fields: [listingId], references: [id])
  participants  User[]        @relation("ConversationParticipants")
  messages      Message[]
  automations   MessageAutomation[]
  createdAt     DateTime      @default(now())
  updatedAt     DateTime      @updatedAt
}

model Message {
  id             String        @id @default(cuid())
  conversationId String
  conversation   Conversation  @relation(fields: [conversationId], references: [id])
  senderId       String?
  sender         User?         @relation(fields: [senderId], references: [id])
  source         String        @default("guest")
  body           String
  metadata       Json?
  createdAt      DateTime      @default(now())
}

model MessageAutomation {
  id             String        @id @default(cuid())
  conversationId String
  conversation   Conversation  @relation(fields: [conversationId], references: [id])
  name           String
  type           String
  config         Json
  lastRunAt      DateTime?
  createdAt      DateTime      @default(now())
}

model Notification {
  id          String    @id @default(cuid())
  userId      String
  user        User      @relation(fields: [userId], references: [id])
  channel     String
  templateId  String?
  payload     Json
  sentAt      DateTime?
  readAt      DateTime?
  createdAt   DateTime  @default(now())
}

model Promotion {
  id          String                 @id @default(cuid())
  code        String                 @unique
  type        String
  rules       Json
  startsAt    DateTime
  endsAt      DateTime?
  redemptions PromotionRedemption[]
  createdAt   DateTime               @default(now())
}

model PromotionRedemption {
  id           String     @id @default(cuid())
  promotionId  String
  promotion    Promotion  @relation(fields: [promotionId], references: [id])
  userId       String
  user         User       @relation(fields: [userId], references: [id])
  bookingId    String?
  booking      Booking?   @relation(fields: [bookingId], references: [id])
  amount       Decimal    @db.Money
  createdAt    DateTime   @default(now())

  @@unique([promotionId, userId, bookingId])
}

model LoyaltyProgram {
  id           String         @id @default(cuid())
  code         String         @unique
  name         String
  tiers        Json
  ledger       LoyaltyLedger[]
  createdAt    DateTime       @default(now())
}

model LoyaltyLedger {
  id              String          @id @default(cuid())
  userId          String
  user            User            @relation(fields: [userId], references: [id])
  programId       String
  program         LoyaltyProgram  @relation(fields: [programId], references: [id])
  balance         Int             @default(0)
  expiresAt       DateTime?
  transactions    Json[]
  updatedAt       DateTime        @updatedAt
  createdAt       DateTime        @default(now())
}

model Dispute {
  id          String   @id @default(cuid())
  bookingId   String
  booking     Booking  @relation(fields: [bookingId], references: [id])
  reason      String
  status      String   @default("open")
  resolution  String?
  evidences   DisputeEvidence[]
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
}

model DisputeEvidence {
  id         String  @id @default(cuid())
  disputeId  String
  dispute    Dispute @relation(fields: [disputeId], references: [id])
  type       String
  url        String?
  payload    Json?
  createdAt  DateTime @default(now())
}

model AnalyticsEvent {
  id            String   @id @default(cuid())
  userId        String?
  user          User?    @relation(fields: [userId], references: [id])
  eventName     String
  source        String
  payload       Json
  recordedAt    DateTime @default(now())
}

model AuditLog {
  id           String   @id @default(cuid())
  actorId      String?
  actor        User?    @relation(fields: [actorId], references: [id])
  action       String
  resource     String
  resourceId   String?
  metadata     Json?
  createdAt    DateTime @default(now())
}

model SearchSnapshot {
  id         String   @id @default(cuid())
  listingId  String   @unique
  listing    Listing  @relation(fields: [listingId], references: [id])
  payload    Json
  indexedAt  DateTime @default(now())
}

model WebhookSubscription {
  id          String   @id @default(cuid())
  targetUrl   String
  secret      String
  events      String[]
  isActive    Boolean  @default(true)
  createdAt   DateTime @default(now())
}

model WebhookEvent {
  id            String   @id @default(cuid())
  subscriptionId String
  subscription   WebhookSubscription @relation(fields: [subscriptionId], references: [id])
  payload        Json
  status         String   @default("pending")
  deliveredAt    DateTime?
  createdAt      DateTime @default(now())
}

